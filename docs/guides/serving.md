# Floyd Serving

Floyd can be used to host REST apis of your trained models which can be accessed over the web. This feature 
is very useful if you want to quickly compare models or have others play with your models. This guide will 
walk you through how to do this.

### Setup project

Clone your favorite deep learning project. For this guide we will be using [Fast Style Transfer](https://github.com/floydhub/fast-style-transfer)
project.

```bash
$ git clone https://github.com/floydhub/fast-style-transfer
$ floyd init fast-style-transfer
```

### Train a model

You can train your model by running the `train.py` script on Floyd. Specify the style image to use. This project also requires access to pre-trained
model - imagenet-vgg-verydeep-19.mat and some training data. Floyd already has this data source available [here](link).

Note that the command uses a tensorflow_py2 environment because this code can run only on Python2.

```bash
$ floyd run --gpu --data <id> "python style.py --style ./examples/style/wave.jpg \
  --checkpoint-dir /output \
  --test-dir ./images/ \
  --content-weight 1.5e1 \
  --checkpoint-iterations 10 \
  --batch-size 20"

```

This will kick off a new job on Floyd. This will take 30 minutes to run and will generate the model. Record the ID of the 
output generated by this run.

```bash
$ floyd info <id>
```

### Evaluate your model

You can evaluate the generated model by running `evaluation.py` on sample images. Use the output id from the training step
as the datasource in this step. Add any image you want to evaluate to the `images` directory.

```bash
$ floyd run --env tensorflow_py2 --data <OUTPUT_ID_FROM_TRAINING> "python evaluate.py --checkpoint /input/wave.ckpt --in-path ./images/ --out-path /output/"
```
You can track the status of the run with the status or logs command.

```bash
$ floyd status <RUN_ID>
$ floyd logs <RUN_ID>
```

Now open the output to see the style transfered images.

```bash
$ floyd output <RUN_ID>
```

### Evaluate pre-trained model

If you want to try out some awesome pre-trained models, we have a datasource for that available [ID:Js534T344XYBPMvWqhxJNj](link) publicly.
You can use that style transfer on any image you prefer. Just add them to `images` directory.

```bash
$ floyd run --env tensorflow_py2 --data Js534T344XYBPMvWqhxJNj "python evaluate.py --checkpoint /input/wave.ckpt --in-path ./images/ --out-path /output/"
```

You can track the status of the run with the status command.

```bash
$ floyd status <RUN_ID>
```

When the experiment is finished, you can see the style transfered images by running:

```bash
$ floyd output <RUN_ID>
```

![Jupyter](img/taipei101_wave.jpg)

### Model API

You can now host this model as a REST API. This means you can send any image to this API as a HTTP request and it will be style transfered. 

Floyd [run](#run) command has a `serving` mode. This will upload the files in the current directory and run `python app.py`. Floyd expects 
this file to contain the code to run a web server and listen on port `5000`. You can see the 
[app.py](https://github.com/floydhub/fast-style-transfer/blob/master/app.py) file in the sample repository. This file should handle the 
incoming request and execute the code in `evaluate.py` and returns the output.

```bash
$ floyd run --env tensorflow_py2 --data Js534T344XYBPMvWqhxJNj --mode serving
Syncing code ...
RUN ID                  NAME                              VERSION
----------------------  ------------------------------  ---------
DJSdJAVa3u7AsFEMZMBBL5  floydhub/fast-style-transfer:5          5

Path to service endpoint: https://www.floydhub.com:8000/t4AdkU6awahkT3ooNazw8c

To view logs enter:
    floyd logs DJSdJAVa3u7AsFEMZMBBL5
```

Now you can send any image file as request to this api and it will return the style transfered image.

```bash
curl -o taipei_output.jpg -F "file=@./images/taipei101.jpg" https://www.floydhub.com:8000/t4AdkU6awahkT3ooNazw8c
```

![Jupyter](img/taipei_muse.jpg)

You will see the default style ([la_muse](#la_muse)) is applied to the input image.

You can also pass in the checkpoint to use and the image will be style transfered accordingly:

```bash
curl -o taipei_udnie.jpg -F "file=@./images/taipei101.jpg" -F "checkpoint=udnie.ckpt"  https://www.floydhub.com:8000/MUDFXViCLArG2drppvU3nm
```

![Jupyter](img/taipei_udnie.jpg)

This uses a different style checkpoint to render the image. All the logic for this is present in the `app.py` file. You can update it to 
be as complex as you prefer.
